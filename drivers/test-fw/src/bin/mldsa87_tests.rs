/*++

Licensed under the Apache-2.0 license.

File Name:

    ml_dsa87_tests.rs

Abstract:

    File contains test cases for ML_DSA87 API tests

--*/

#![no_std]
#![no_main]

use caliptra_cfi_lib::CfiCounter;
use caliptra_drivers::{
    Array4x12, Hmac, HmacData, HmacKey, HmacMode, HmacTag, KeyId, KeyReadArgs, KeyUsage,
    KeyWriteArgs, Mldsa87, Mldsa87Msg, Mldsa87PubKey, Mldsa87Result, Mldsa87Seed, Mldsa87SignRnd,
    Mldsa87Signature, Trng,
};
use caliptra_registers::csrng::CsrngReg;
use caliptra_registers::entropy_src::EntropySrcReg;
use caliptra_registers::hmac::HmacReg;
use caliptra_registers::mldsa::MldsaReg;
use caliptra_registers::soc_ifc::SocIfcReg;
use caliptra_registers::soc_ifc_trng::SocIfcTrngReg;
use caliptra_test_harness::test_suite;

const PUBKEY: [u32; 648] = [
    3835505740, 3690007112, 853915369, 3693662018, 211942217, 3990077002, 2138588545, 3148197939,
    1360552520, 1893999810, 2142558518, 3550487038, 1629582640, 4207496438, 1624023420, 2321076701,
    3307728476, 2489502174, 981334409, 1164785223, 332671519, 153489343, 3397652780, 3957245118,
    2351323958, 2986875746, 2812917730, 3922720212, 1244743471, 605031300, 4056029767, 4181389605,
    1477281975, 2005702823, 1887259589, 2362260311, 3144662306, 3178107212, 2646344715, 3976901390,
    945382933, 1883457695, 2932015503, 3458972163, 3537662277, 4085675767, 1687087098, 1946150878,
    3219123200, 634562974, 1377987728, 3417383429, 2508513319, 2747979415, 4157402002, 1787205210,
    4174312139, 2316372670, 124309646, 3154808130, 125070196, 1368510060, 3601317111, 2064452163,
    4079260541, 901630114, 3251517436, 869381668, 4177790917, 1607707881, 231960692, 673287986,
    2277284076, 505705949, 3088167856, 1684583314, 1208388560, 3525850503, 2030451626, 327646581,
    877386528, 2360574569, 843228669, 3898825448, 3303275125, 3538169167, 2867752098, 1181193899,
    1021152497, 4205788195, 346620700, 376410217, 3680000168, 327497578, 553074626, 2366078710,
    4155947128, 200091752, 949927105, 1498873058, 3230849477, 1507259046, 708031178, 2295433290,
    1249428000, 3381327710, 3875440368, 3648849260, 52591107, 949831489, 3652235435, 3987982322,
    1861972534, 1377671987, 3905205197, 1514206689, 14480875, 836243961, 2337991485, 2869081407,
    3380346755, 2877464420, 429496806, 411369132, 278994683, 3437145682, 2250043483, 4019811594,
    910627272, 309030717, 1424414312, 2869433891, 92229327, 1835649107, 3592527850, 1497599740,
    3572206638, 2555816180, 4269356224, 3667981423, 2734805828, 87954250, 3622675868, 3907571364,
    4013581018, 3186315659, 3535233543, 1038874152, 3043337822, 2993178926, 571187271, 3668353355,
    3022759514, 2338223191, 2821892937, 197592418, 2400579529, 1743992916, 361676534, 676289517,
    3649769049, 1658659424, 4196073367, 2929650806, 3590540143, 205950218, 1543556740, 710122142,
    2754933547, 2673169005, 355066970, 1249642637, 793188832, 3850641309, 2489675968, 694013155,
    868793614, 3747869115, 255274388, 2434080473, 2338399868, 4154725563, 75073083, 3445901847,
    3109344337, 1659086204, 3429188076, 205045175, 789340315, 2091221152, 2489780142, 2304628220,
    3021279696, 297879459, 2647148146, 1307315161, 3220826142, 611084572, 2801469214, 3455242732,
    527730487, 1354208284, 493764011, 4023355622, 196256640, 364425337, 1023920522, 2187596207,
    3147216541, 2729626387, 1015174589, 382810384, 1673935089, 347353025, 1236701819, 2756197421,
    872795364, 1367532144, 3961880874, 4127501940, 1349428569, 676751886, 191409789, 3089396477,
    854439707, 247534677, 3101099142, 4141912815, 3488031487, 2712407939, 2613920377, 2588794055,
    4193782955, 2140616878, 107002602, 996081534, 4033583273, 3224283625, 3536695041, 2721134619,
    1709018856, 4056597405, 3106835985, 1502638122, 1162691296, 749533484, 1069503121, 2944311770,
    1294350480, 1544869020, 1900612708, 4245802745, 826515054, 1976246210, 3865278506, 468549788,
    2480036965, 847939832, 775621323, 4202318293, 2912271353, 4226199943, 1991619492, 2265713453,
    1738264887, 465885017, 453717684, 3433749626, 987564801, 1387264614, 2732275350, 1833084776,
    113558274, 1520169825, 1363505843, 2062085954, 2721127956, 347915132, 3902409908, 106170807,
    2206516323, 444970924, 1794422744, 3862221232, 1811212352, 1880621946, 1698564412, 1069207036,
    2399087675, 3710933778, 70035203, 2155912438, 2762234532, 2617070659, 1847666318, 503168021,
    2640210218, 567806325, 2098618861, 4114845061, 3023222550, 3947243527, 3717067821, 3349425571,
    1713300375, 3628243695, 1308237842, 2556437298, 4206700420, 1541425853, 332776413, 15192838,
    4256417894, 367564395, 2888310364, 1593022648, 3590422118, 2857949937, 267186593, 1887197702,
    491476472, 657400618, 370093181, 426516777, 4285496730, 4054097414, 2247656359, 1847321496,
    3484326429, 3244821993, 3812591400, 666689402, 1020756656, 2974443398, 3128679780, 2058817366,
    4289993554, 1649332787, 2551616546, 1864020586, 3063732205, 594644720, 2407950835, 3914712536,
    689023260, 3263828286, 298305756, 2693676558, 3814824665, 949629957, 2287916001, 1676597360,
    83058381, 1421263811, 1901009266, 3193142678, 2208914420, 1752735183, 2499739657, 4000154409,
    3153353492, 1414269807, 2010658634, 2245036648, 4170633359, 3693436965, 2915221252, 587768780,
    3922410943, 472822372, 3322011645, 727329216, 1111132167, 174210383, 2708829166, 470130578,
    4294003929, 1727801621, 3150192052, 2593048451, 691062747, 2062118730, 708132712, 3662429152,
    1771840790, 446736485, 6033911, 1762021026, 1989207095, 2407511518, 1868415448, 1354217781,
    2311724406, 2553085627, 276962272, 3173482352, 1043422172, 2748275980, 2499152999, 2542950764,
    3210672876, 2193847090, 3828183800, 571655365, 3285724765, 3558499129, 864021632, 1519996612,
    2149617990, 1827942798, 1517069905, 2076842343, 3166683701, 4135819432, 401084494, 2770638344,
    2289113214, 4220797801, 1385054947, 115289159, 2593592910, 3865965959, 1333885663, 2184975304,
    262324467, 3815054819, 975975661, 3114300172, 2477558831, 3147705342, 3846009555, 904140561,
    1583014044, 2794581513, 1952489756, 1874603361, 3598252764, 3836182028, 1528604965, 1352378289,
    4280497114, 4214644634, 4072424665, 2560478308, 3918038819, 2678001497, 1030496550, 3569162027,
    1531689162, 2775288505, 1989555613, 834664648, 3315723406, 3965794212, 2166894517, 467318305,
    2184641744, 4229786236, 654746860, 2390171719, 3647950863, 2510404217, 3856068584, 2991052485,
    3653680925, 4115196215, 2090393593, 3968235621, 938042798, 1889214348, 1352070829, 2319552824,
    1759957236, 2703319348, 4175050854, 3627343110, 2716196312, 2610124474, 2695944232, 1365173423,
    2111724401, 2548134146, 3708290397, 2317081907, 21672697, 3582447266, 1348987372, 3509519336,
    3115628136, 3293173393, 3396884916, 594701625, 2157023884, 1552974849, 1088012654, 1708871923,
    1428317425, 4207803940, 1284116655, 4137934796, 1061258750, 3498196015, 448728840, 1094337579,
    1151201108, 2510273848, 2667653093, 83462197, 3252698350, 558253128, 1035779300, 914714474,
    2474593659, 1906940452, 1401817629, 3671748450, 1819155233, 826004266, 3591211124, 2451243598,
    385248232, 2943103549, 1294686679, 147885499, 1044143741, 2656085092, 2117138255, 3826769787,
    2325011303, 1261031236, 90882208, 1294319489, 4234088270, 1539621717, 2350806595, 2091240943,
    825105881, 1675247520, 913780312, 2768394429, 1866358946, 1660292783, 3532954947, 1016386981,
    2562041260, 3308974427, 3285102325, 1815931317, 399229492, 3184398188, 209126227, 271932684,
    1846873165, 1194829654, 259008652, 3864862867, 3673293568, 3245532430, 832013312, 2980595141,
    1242800537, 2596151996, 2544832325, 1262209648, 2536652551, 2485947692, 4050026344, 2241214987,
    811402885, 3564165870, 1305255012, 1735112176, 3386522285, 2815521371, 814254733, 2233978583,
    2864645280, 2856647917, 3517162201, 235922125, 793604155, 3703765138, 2010123689, 1856069358,
    1234370716, 463596139, 2036947345, 1707394308, 84492501, 3716413660, 1016495067, 3049347978,
    1524690701, 4071452228, 4249981944, 3122583637, 3369522021, 1649772653, 3056763155, 280473868,
    1199408136, 1720782365, 2200722455, 960586046, 3034452656, 2247171250, 1575628304, 3365044929,
    3168772664, 1972177563, 574185332, 544749540, 765311001, 3550069312, 2924697659, 1821128552,
    2792612345, 3015522820, 4042045268, 1763110250, 2019480958, 3376348025, 1309091499, 3999310909,
    2697821919, 3882803189, 2065268521, 497892775, 4204300988, 576939228, 499665412, 1452576809,
    830700972, 780887356, 3710155016, 610308312, 2155998756, 1587835863, 1094683625, 1430119721,
    3683267155, 2232510094, 1878731451, 4206578077, 1923495852, 2699413811, 3884983424, 2434813941,
];

const SIGNATURE: [u32; 1157] = [
    3483939, 521999120, 100663296, 0, 0, 0, 0, 245, 4108507062, 2624280656, 1176240631, 4104937540,
    415006791, 647579123, 4075611052, 2672503563, 133414018, 3855399609, 2339915564, 437639831,
    1816409894, 2848095759, 2263379491, 1379541929, 755746403, 4285752040, 1018246763, 3620734437,
    4288214564, 1980957844, 3951065191, 1480753947, 3853702608, 4041491009, 1974314193, 3987996886,
    3238492056, 1330710077, 2682909822, 3928158732, 1715373663, 2865511117, 1416642615, 3234986865,
    697051757, 3465367280, 2239264509, 2813950375, 1135272953, 3189904621, 3563680954, 3475151066,
    781662814, 2699199005, 4206680392, 3396798190, 824315944, 2523025982, 1120452894, 2610958712,
    1010475033, 808606328, 2026610856, 915564689, 1260693274, 2171381782, 1957534969, 2940154918,
    3814134795, 4107578092, 1930723949, 1065269541, 1524133744, 1620966274, 3730712086, 797253300,
    267939432, 1504891849, 570010104, 1809715011, 1508585873, 1287096652, 138916478, 2253161470,
    1319207366, 3410356452, 539065145, 4007355991, 3784936298, 1191764199, 3191390947, 3867555644,
    2065189397, 115850537, 2084212604, 1313717956, 813057830, 3181244187, 3067739191, 1014575551,
    3095998111, 1204633610, 2697045139, 1256573837, 3823517592, 877480771, 4108292905, 1729589925,
    1626534454, 515437163, 2866360694, 901452089, 3576513422, 847697724, 187961676, 1833648983,
    3856118506, 2781594665, 2963179353, 2680298018, 3712303720, 965154659, 3802966738, 1376719586,
    3474770615, 3042344814, 2014140808, 3582270987, 3324777469, 1505615840, 3194448302, 2716196171,
    3682624971, 703452001, 3815614308, 659274968, 2792936621, 956779727, 1259544566, 3652190074,
    1807211919, 3781084950, 843882164, 3047947693, 3011039985, 737393128, 132255088, 2343177356,
    2003484981, 2566836641, 3217006151, 1258893055, 2958184894, 850379771, 327404585, 1702757314,
    984312424, 45514538, 1695196082, 1665294266, 3626131503, 756017751, 3566507107, 2550418942,
    2988446447, 701857286, 2121241915, 2334736800, 1055934807, 265748924, 2951664827, 2003390109,
    3120026087, 161831000, 3694485875, 2180009426, 3673071894, 3216319070, 715518671, 1815738122,
    4116294332, 1707070789, 1647929153, 1046229896, 4245038121, 3180608262, 3474955444, 1207497517,
    1195805480, 2136893302, 4002402466, 4069700056, 3667767286, 4164828796, 1328396374, 307914491,
    2989035025, 1544353146, 1978581962, 2026911356, 2575814726, 523211335, 1501401920, 1670087037,
    1952883631, 3955758678, 971743979, 1614148907, 4049669260, 2387954201, 1359307907, 1140244752,
    2985614434, 2642517195, 3779989706, 3856343637, 1366504965, 3528029229, 4238806389, 1170838776,
    1706572567, 1154208587, 4241159766, 3521571709, 3333299255, 3499204452, 2146829409, 2647490724,
    490487324, 2749023514, 1957422725, 2548515566, 554290071, 3930370263, 468342854, 4040365485,
    1916333753, 693241742, 923559992, 2726167656, 1899972603, 2121274744, 962228659, 2251670377,
    2107225654, 2634182873, 3834573685, 2108775245, 2393396192, 3677993775, 3160661167, 2373004366,
    983123886, 2453497015, 1490428571, 3366809924, 122302355, 92433838, 2261585157, 2268967007,
    2851796981, 3069704281, 3518011170, 2872230314, 1068021479, 4211788231, 3886478663, 3883789033,
    745181774, 4022863824, 1581393837, 4099881813, 2024855284, 3272133842, 693656589, 3222808734,
    2340753177, 3188268385, 2440255132, 3738386632, 3872215554, 3325915355, 1701464017, 2673685193,
    3260392999, 3404119660, 3728460287, 1268291414, 1840969587, 3410148302, 2761729965, 1361626387,
    3938040093, 3189663269, 382236280, 980432740, 2801760673, 2175390733, 2783782142, 3241938427,
    2537281548, 125585924, 178124797, 1695713711, 118334326, 3391395466, 771825760, 2879481533,
    609275472, 4175493584, 2867964072, 229844131, 1502062456, 1753291212, 2463332422, 442435538,
    456361654, 996848018, 201416207, 109688446, 2420524234, 1016901208, 3880822677, 1733215341,
    1771278875, 1548096047, 855799376, 900429570, 3432749675, 3845503946, 1246597775, 3176984146,
    2779487400, 3595843796, 1508824013, 3344689081, 3066754071, 908637894, 1204147638, 3612391946,
    63637619, 1753235821, 643748983, 1937022120, 641227713, 1723780373, 1862487596, 900714888,
    4139884928, 4167068665, 2048003618, 582377870, 4030764678, 411333635, 3976288287, 2345748187,
    120698673, 2379480016, 565025403, 1185331536, 3734248691, 1131009255, 3544829457, 2751784962,
    3044072588, 2330475124, 1617724475, 923323036, 266523945, 1663089233, 329941353, 2530805366,
    4289020771, 711189711, 2773176806, 2829476405, 225651107, 2950084307, 3770234823, 1408566122,
    4174796499, 708035424, 55896065, 1026549964, 86876176, 571525747, 2578022306, 701157729,
    2444686102, 3032970791, 3529043050, 273460631, 629506790, 3537313071, 2912495144, 315493749,
    641560720, 213862464, 3748375523, 2408678230, 892653440, 2857225440, 4057435303, 4234040337,
    1350420771, 276399205, 1938734783, 2728408015, 2000394999, 2213158519, 1654107971, 3412905394,
    700311782, 2727788342, 2049935350, 2107325747, 4032381835, 1661054657, 1408724297, 1917878087,
    3572024719, 2825274734, 4025593357, 4104923669, 4193864972, 2544846724, 230141891, 3820244983,
    3585664818, 1531740762, 4147218475, 3349803884, 3865771690, 981182634, 495177940, 1060287394,
    1419059043, 2615003869, 3995533902, 1919538835, 1842233019, 2835445344, 745163061, 1799702147,
    1312210688, 1149696010, 2214401988, 1201270969, 2459311004, 2197298614, 1736363830, 1284055503,
    2812215644, 3650267915, 1221954155, 2908722048, 1898434850, 1978958825, 2092858461, 3701975177,
    3294747282, 3604303028, 3057753754, 2894190667, 189553007, 2262069855, 3368576068, 1791667036,
    3699882005, 672484092, 3610189956, 3039367577, 2118342693, 4292278019, 113381786, 258757295,
    2054239563, 3472635999, 1884817045, 2662874841, 752590224, 1803068175, 2283875682, 1748329994,
    2845653526, 1659049857, 2357570251, 800237862, 2481052470, 367444637, 3851080696, 3950199239,
    3483080897, 869848594, 1783502467, 443812027, 1971171371, 3539471347, 1335903334, 3867720991,
    3698869563, 1153693927, 2363740600, 1748764390, 3160149203, 2504352385, 3366568280, 694586818,
    2808576899, 2285741991, 957515591, 1467768796, 3104486384, 790628302, 1413636976, 2304316431,
    3611614642, 760796948, 1806919628, 475280102, 3209433007, 3401510953, 2822495175, 4185414410,
    1927358681, 4113297514, 3454889141, 2667229652, 1425489180, 2264869031, 2106190620, 1556596787,
    2199639048, 3585881527, 280132343, 803294801, 4090650850, 2515886307, 3031464834, 1987988890,
    3892166141, 519696257, 3396463856, 1117662300, 1913001368, 3779723848, 2126649939, 2532613616,
    312953324, 3361076328, 758285740, 1580950601, 2845688031, 3188249764, 3484953175, 1527879544,
    2906441699, 2659563578, 1253842791, 3740576111, 2485940873, 4001170087, 20466154, 2520182511,
    2696302147, 1666279631, 104375688, 3797570589, 3996336624, 1942086677, 4162613243, 1592896301,
    3320939793, 1959770394, 796445298, 4267307774, 1342876866, 732103231, 4187637441, 2613443555,
    1265900123, 496964673, 2364765295, 3311290611, 4029546362, 328242252, 3187010175, 1871500749,
    4235934897, 2114298059, 2525331042, 3121075721, 3642752298, 155602140, 1188869964, 311488138,
    1730942852, 1742785612, 1382176323, 319655915, 2323099779, 280011797, 999132211, 1641954815,
    459016450, 1036618376, 429857691, 3042710263, 3235308786, 3292724864, 2717606190, 2465409799,
    3833219663, 2590838480, 1326783762, 1336136212, 1060511750, 3473746084, 1018822781, 3210110655,
    2555412396, 2317268973, 3420666960, 104528580, 3005799115, 270135403, 2466801209, 53743101,
    1391510453, 3898714781, 4141241224, 2746567452, 1323198572, 987021013, 1296208133, 91888146,
    3582844289, 779394152, 59324756, 3089488499, 1052953106, 1666079714, 3817015816, 2661404601,
    2581028977, 1797941631, 783208245, 123595769, 1045470041, 4286479622, 4268336920, 3740450224,
    1073025324, 2615201268, 3551363719, 3116931556, 3553502281, 732692928, 79015140, 372099450,
    3912635577, 3864844689, 201284591, 1940867971, 3925027766, 1385443689, 3276481064, 504342196,
    2570215156, 3439398111, 2437322665, 4023899304, 3923992818, 2631444297, 1211103654, 1748967079,
    79677837, 6472570, 546523084, 2834121213, 342323508, 519591137, 3215723301, 4144428236,
    744952996, 3168001149, 3253051455, 4181776365, 552513934, 1020539612, 2247501579, 4096486988,
    365580360, 3175398371, 793070746, 2866723158, 542692116, 2621489897, 567911732, 219132416,
    430188660, 1574488078, 1422017461, 2551307203, 2335659730, 2527283304, 3173979068, 2174834098,
    3154287353, 4037908379, 3091510384, 3323023781, 2674607470, 3627989105, 4222417810, 834853594,
    1579570754, 2739695446, 1011875020, 2771871084, 15669276, 2267550271, 924800866, 1751880966,
    1438441283, 2031403467, 2800291764, 1043086414, 1874593120, 3893078853, 395320579, 2342234894,
    1918886391, 44663255, 1928829354, 3168705108, 1070052314, 932756030, 3178904745, 2661625486,
    2006640442, 1962615663, 3201112321, 2868925614, 2851498044, 2619449693, 2026589124, 1425043953,
    2301054257, 3763598920, 4100781958, 371740223, 2669123952, 863992094, 1739347394, 2977155718,
    2916679714, 250583732, 3218227922, 2540642823, 1674413283, 1179936624, 82357985, 1698019874,
    1662602624, 2921300640, 654389102, 4222399399, 257443340, 2855901585, 2615137047, 644788972,
    3138249204, 2138456463, 1769804186, 1346100230, 819726703, 4101756397, 3110950805, 131492342,
    987103970, 2985643437, 562839684, 2801264321, 2446395840, 1327994822, 2090667167, 2848856300,
    2291022998, 3914984892, 1222297168, 2093967305, 4223720066, 3567533073, 119952158, 3303137004,
    974234688, 580198689, 2252515257, 873990923, 297309932, 3892861670, 2481538783, 3307366365,
    3815119109, 404611701, 1478637237, 2259081438, 1179002670, 2484737104, 2642760080, 3908197898,
    1316679886, 3038398049, 2133877605, 392838971, 161778653, 3281309872, 4081079557, 3917857812,
    2989237592, 2402892048, 804108256, 2953269448, 1803308404, 1612927287, 1814201568, 482853606,
    2136544017, 3945067248, 962851746, 1670296455, 1571422899, 3118167642, 3272126861, 2396917635,
    1241376871, 492570214, 385323601, 2338479390, 2454828169, 4212096206, 3774292546, 2019209515,
    3221683391, 3911375765, 1041588220, 3627622624, 2449385147, 971902250, 637192748, 2063578726,
    3310932702, 745251349, 2022411029, 787080449, 46509173, 4063989301, 1894155381, 1579804366,
    1173240570, 2019350564, 3574676004, 3407918332, 533931826, 2265357816, 2075152638, 1697450436,
    1386665990, 503108984, 3686728296, 110154851, 1471911411, 3279282640, 3902295786, 638755044,
    870828992, 3997259781, 3236001065, 285503507, 3467613581, 4169315526, 3926758147, 3771833215,
    260854571, 4010701574, 2002284284, 3668948517, 212067558, 3043278569, 368491438, 3713406768,
    2246095050, 2026456225, 2838110818, 3788689614, 1620794981, 2819640617, 2641876507, 1252451229,
    2827662670, 1013940260, 1479072234, 1136633339, 4003637638, 2566413422, 982092614, 2080700612,
    2761767774, 750431029, 1732121548, 1162803477, 1414934932, 1385449608, 3389452599, 155994728,
    2941444120, 1371692319, 647339962, 3693251687, 1090034923, 965445045, 3713870878, 194232423,
    2356367899, 3382373329, 3739499331, 2224653945, 2832313203, 331210661, 2316858776, 407027904,
    2928960295, 258931087, 16694930, 3867038963, 3562570621, 690341941, 3952280579, 1280450006,
    574230857, 2634872307, 3688931437, 1679202816, 1041911733, 3998921061, 2682322625, 3291640815,
    3832354924, 2569294652, 2428891200, 2002190808, 3210197411, 109983240, 1509378744, 1909503852,
    3568929343, 430491982, 1359989452, 2563577680, 1283661532, 2317069527, 513834834, 2226612444,
    2633662920, 4239984271, 4206522427, 1311099223, 1377727423, 1551950428, 2714375733, 215865308,
    2582328150, 3342179909, 283537159, 3688763582, 1280451557, 2175708934, 3961410411, 4034335397,
    1111967636, 676544001, 3722407994, 1973259880, 3524111387, 2415779692, 1696710394, 633868414,
    3648171816, 2738850418, 2797429079, 1738914050, 1145938623, 483868765, 4220680623, 2458694892,
    338412749, 2803004468, 650329775, 2796438993, 2630422865, 1579852491, 627435154, 32019063,
    478922440, 706074587, 4250312290, 1180019718, 3229652978, 2348174337, 538519390, 4282947256,
    3644967745, 3599406024, 963376665, 28592788, 1326246399, 2924938164, 3526714680, 793712288,
    538368658, 503282861, 1517456850, 2362143653, 3839009043, 2766271180, 1157301247, 3263179676,
    1152411750, 3800295229, 2724560134, 3733853300, 1303167626, 2800180110, 3775908789, 4177248034,
    176866424, 817621391, 1652924103, 3940527432, 430414596, 3231901644, 2915740774, 252473166,
    2754119916, 2631826221, 1843934856, 587616052, 3323059488, 796429595, 306273045, 2710728275,
    488063220, 3475331455, 1246123424, 1296809196, 3997316062, 232434427, 3910175269, 736118015,
    2441150499, 2146973686, 2588544253, 2804903125, 305906418, 69865260, 154590866, 1593370389,
    3131700559, 1525127884, 3674049981, 175978676, 1920957070, 612285564, 1254440733, 184870849,
    769674129, 340138643, 3029240445, 2080193459, 936820557, 3910951228, 1835832931, 3508716227,
    180716371, 3477745385, 1620672917, 1323116139, 3590879332, 530259464, 3668820094, 3427616953,
    2745929424, 2557179765, 3807862668, 265123189, 3556935325, 3327614087, 3715049245, 293528550,
    1404942760, 1251895207, 523633966, 3975427038, 325994384, 168668510, 2925241224, 2878278597,
    1852576518, 1319168586, 3410879472, 4176103748, 2723141573, 1740816802, 2296546207, 831445790,
    2622172801, 2840969084, 358196726, 2995873183, 2983345700, 1117408773, 3165180915, 707023524,
    211100107, 3461747945, 2608006032, 1628301893, 2274284492, 2314321986, 1662004698, 1885857252,
    1208036899, 1492401750, 4177445910, 2522365168, 2594471163, 316688821, 941287310, 3642612050,
    695360364, 2537263092, 783523991, 1739629107, 2315845209, 2315311235, 719945459, 814407807,
    2495231737, 2248305350, 3228435827, 3985741157, 311482630, 1110330844, 1667991847, 1414688453,
    92869083,
];

const MESSAGE: [u8; 64] = [
    29, 204, 154, 221, 65, 56, 204, 167, 12, 130, 160, 47, 200, 7, 250, 159, 194, 82, 16, 98, 102,
    89, 177, 73, 39, 15, 105, 116, 233, 169, 31, 160, 5, 186, 46, 229, 44, 126, 198, 98, 20, 39,
    194, 203, 249, 170, 183, 196, 80, 111, 6, 194, 23, 17, 183, 73, 119, 95, 8, 123, 190, 17, 14,
    186,
];

const KEY_ID: KeyId = KeyId::KeyId1;

fn test_gen_key_pair() {
    let mut trng = unsafe {
        Trng::new(
            CsrngReg::new(),
            EntropySrcReg::new(),
            SocIfcTrngReg::new(),
            &SocIfcReg::new(),
        )
        .unwrap()
    };
    let mut entropy_gen = || trng.generate().map(|a| a.0);

    // This needs to happen in the first test
    CfiCounter::reset(&mut entropy_gen);

    let mut ml_dsa87 = unsafe { Mldsa87::new(MldsaReg::new()) };

    let mut hmac = unsafe { Hmac::new(HmacReg::new()) };
    let key_out_1 = KeyWriteArgs {
        id: KEY_ID,
        usage: KeyUsage::default().set_mldsa_key_gen_seed_en(),
    };

    hmac.hmac(
        &HmacKey::from(&Array4x12::default()),
        &HmacData::from(&[0]),
        &mut trng,
        HmacTag::Key(key_out_1),
        HmacMode::Hmac384,
    )
    .unwrap();

    let public_key = ml_dsa87
        .key_pair(&Mldsa87Seed::Key(KeyReadArgs::new(KEY_ID)), &mut trng, None)
        .unwrap();
    assert_eq!(public_key, Mldsa87PubKey::from(PUBKEY));
}

fn test_sign() {
    let mut ml_dsa87 = unsafe { Mldsa87::new(MldsaReg::new()) };

    let mut trng = unsafe {
        Trng::new(
            CsrngReg::new(),
            EntropySrcReg::new(),
            SocIfcTrngReg::new(),
            &SocIfcReg::new(),
        )
        .unwrap()
    };

    let sign_rnd = Mldsa87SignRnd::default(); // Deterministic signing

    let signature = ml_dsa87
        .sign(
            &Mldsa87Seed::Key(KeyReadArgs::new(KEY_ID)),
            &Mldsa87PubKey::from(PUBKEY), // Reuse SEED
            &MESSAGE.into(),
            &sign_rnd,
            &mut trng,
        )
        .unwrap();

    assert_eq!(signature, Mldsa87Signature::from(SIGNATURE));
}

fn test_verify() {
    let mut ml_dsa87 = unsafe { Mldsa87::new(MldsaReg::new()) };

    assert_eq!(
        ml_dsa87
            .verify(
                &Mldsa87PubKey::from(PUBKEY),
                &MESSAGE.into(),
                &Mldsa87Signature::from(SIGNATURE)
            )
            .unwrap(),
        Mldsa87Result::Success
    );
}

fn test_verify_failure() {
    let mut ml_dsa87 = unsafe { Mldsa87::new(MldsaReg::new()) };

    let msg = Mldsa87Msg::from([0xff; 64]);

    assert_eq!(
        ml_dsa87
            .verify(
                &Mldsa87PubKey::from(PUBKEY),
                &msg,
                &Mldsa87Signature::from(SIGNATURE)
            )
            .unwrap(),
        Mldsa87Result::SigVerifyFailed
    );
}

test_suite! {
    test_gen_key_pair,
    test_sign,
    test_verify,
    test_verify_failure,
}
