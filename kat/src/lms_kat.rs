/*++

Licensed under the Apache-2.0 license.

File Name:

    lms_kat.rs

Abstract:

    File contains the Known Answer Tests (KAT) for LMS cryptography operations.

--*/

use crate::caliptra_err_def;
use caliptra_drivers::{
    CaliptraResult, HashValue, LmotsAlgorithmType, LmotsSignature, Lms, LmsAlgorithmType,
    LmsIdentifier, LmsSignature, Sha256,
};

caliptra_err_def! {
    LmsKat,
    LmsKatErr
    {
        DigestFailure = 0x01,
        DigestMismatch = 0x2,
    }
}

#[derive(Default, Debug)]
pub struct LmsKat {}

impl LmsKat {
    /// This function executes the Known Answer Tests (aka KAT) for LMS.
    pub fn execute(&self, sha256_driver: &mut Sha256, lms: &Lms) -> CaliptraResult<()> {
        self.kat_lms_24(sha256_driver, lms)
    }

    fn kat_lms_24(&self, sha256_driver: &mut Sha256, lms: &Lms) -> CaliptraResult<()> {
        const MESSAGE: [u8; 8] = [0, 0, 30, 76, 217, 179, 51, 230];
        const LMS_TYPE: LmsAlgorithmType = LmsAlgorithmType::LmsSha256N24H15;
        const LMOTS_TYPE: LmotsAlgorithmType = LmotsAlgorithmType::LmotsSha256N24W4;
        const Q: u32 = 0;
        const LMS_IDENTIFIER: LmsIdentifier = [
            97, 165, 213, 125, 55, 245, 228, 107, 251, 117, 32, 128, 107, 7, 161, 184,
        ];
        const LMS_PUBLIC_KEY: HashValue<6> = HashValue([
            4139166856, 3602845794, 318997898, 2236488139, 3162486332, 3951052027,
        ]);
        const NONCE: [u32; 6] = [0, 0, 0, 0, 0, 0];
        const Y: [HashValue<6>; 51] = [
            HashValue([
                168020299, 3031637807, 2854539709, 3427790810, 1501766160, 3315863183,
            ]),
            HashValue([
                3702818756, 1562621517, 955566089, 4245279421, 2829717494, 264532353,
            ]),
            HashValue([
                4186943276, 1764854231, 517703670, 2777415938, 2007463527, 3816943928,
            ]),
            HashValue([
                3902267657, 3264914214, 1424241370, 993928517, 1332465367, 2282219858,
            ]),
            HashValue([
                4076095549, 3833327140, 3357849446, 3680325648, 784246614, 1938427986,
            ]),
            HashValue([
                4268035817, 3314441437, 3489755338, 204551489, 17575154, 3492565060,
            ]),
            HashValue([
                2621931857, 1571790001, 786951332, 1863663725, 729430632, 3519134787,
            ]),
            HashValue([
                2490149279, 1307211027, 4127992189, 1336843116, 860192030, 3671912655,
            ]),
            HashValue([
                1895330945, 4100635751, 1685922548, 1565528116, 1604383578, 3830067514,
            ]),
            HashValue([
                1734608626, 2550092606, 1913822761, 3142502859, 2801441676, 3520826637,
            ]),
            HashValue([
                2829556847, 4056766628, 2214378805, 3056807578, 2299761829, 3055547162,
            ]),
            HashValue([
                2288380734, 2213866990, 3591701700, 3143512235, 2164325023, 2572517113,
            ]),
            HashValue([
                3003867556, 245396916, 513114185, 2807014565, 3297137848, 3758317968,
            ]),
            HashValue([
                125588746, 1507189940, 2861198246, 455541251, 469441010, 2420278448,
            ]),
            HashValue([
                3049033895, 3474606683, 3270672093, 56050791, 1486565234, 3716970846,
            ]),
            HashValue([
                801838551, 1278505883, 1346361613, 1608468963, 1548983454, 3515057578,
            ]),
            HashValue([
                3055120304, 3348039372, 3123864902, 3945574328, 2449967824, 2699102090,
            ]),
            HashValue([
                2251812316, 198105975, 288819734, 1610484839, 2043761784, 1083727888,
            ]),
            HashValue([
                312239753, 1203719658, 1821113767, 100348813, 4190298157, 4256425499,
            ]),
            HashValue([
                749633601, 506677604, 1532324863, 3936913715, 2613487011, 345347736,
            ]),
            HashValue([
                827629973, 2055705471, 390999221, 4261372633, 3771256389, 2429531790,
            ]),
            HashValue([
                780603499, 632785203, 2007658966, 1139399430, 2883173721, 1196739668,
            ]),
            HashValue([
                4292434099, 540399647, 4122148139, 2873018422, 1952965187, 3858740066,
            ]),
            HashValue([
                2045857689, 447949114, 911066599, 4038132764, 2386909417, 558218065,
            ]),
            HashValue([
                217384202, 2958527519, 2631112269, 1178705288, 2346224897, 1932284395,
            ]),
            HashValue([
                1258546674, 1820934222, 2969822746, 2237091853, 2091527792, 2900238260,
            ]),
            HashValue([
                2934089981, 259561327, 3425115280, 2559642578, 1214054321, 1839231695,
            ]),
            HashValue([
                1366527532, 4109920876, 3286315127, 937194897, 2723753272, 3879951559,
            ]),
            HashValue([
                1611040347, 2418049761, 1548139376, 1385664655, 2026437608, 3901971760,
            ]),
            HashValue([
                550296304, 861504928, 3068528653, 720638008, 1802435648, 4025083753,
            ]),
            HashValue([
                488034274, 310420838, 470880456, 4234307546, 864234985, 3691302601,
            ]),
            HashValue([
                3815482822, 1281882288, 3706709970, 3485006577, 3897979690, 4111106622,
            ]),
            HashValue([
                621840712, 729128104, 3459606711, 331785230, 481148213, 1256266803,
            ]),
            HashValue([
                2349672374, 3053595118, 2170776299, 3231286818, 1476065724, 525869303,
            ]),
            HashValue([
                3559333279, 2604503720, 2349626942, 2848161495, 3329844239, 2207309207,
            ]),
            HashValue([
                1697620265, 1052295597, 4177652065, 2854127836, 240666298, 1068582342,
            ]),
            HashValue([
                3026806483, 3704770248, 3220676928, 2537004000, 1887769195, 1298543398,
            ]),
            HashValue([
                2800111217, 1851995414, 2633900052, 2616118211, 3724277657, 3818920061,
            ]),
            HashValue([
                1832279718, 3436714157, 2329428834, 3842580143, 3034913244, 403200745,
            ]),
            HashValue([
                1466245119, 2492151936, 3117352989, 2367370970, 2958627928, 672935958,
            ]),
            HashValue([
                732533914, 713728067, 787610008, 896370011, 2797363791, 1450066611,
            ]),
            HashValue([
                2020561653, 1161427469, 489289957, 3632968733, 1424462212, 3573271683,
            ]),
            HashValue([
                2720120634, 138803131, 436542809, 1507191419, 3751099191, 999988658,
            ]),
            HashValue([
                2211662570, 243541246, 2324471730, 1001902922, 1829236638, 1992808928,
            ]),
            HashValue([
                3865608697, 1368162222, 3213467843, 3444958874, 1066654721, 3323744192,
            ]),
            HashValue([
                2295384457, 3972408601, 3540157296, 1353134486, 1655884637, 1918749846,
            ]),
            HashValue([
                858449536, 109539603, 4185398863, 1639585695, 68249553, 3270388062,
            ]),
            HashValue([
                3846027832, 1071965471, 1399567139, 2617455790, 2402906813, 606418847,
            ]),
            HashValue([
                3501250858, 2029644713, 1686846111, 1003111587, 3136828978, 1833050221,
            ]),
            HashValue([
                1519161009, 2411682802, 2376375165, 780779863, 1648723927, 671847298,
            ]),
            HashValue([
                799853646, 519943359, 3890705368, 2671107700, 208053441, 1127085958,
            ]),
        ];
        const PATH: [HashValue<6>; 15] = [
            HashValue([
                581307680, 176568492, 1340119059, 878394249, 3847025554, 487025439,
            ]),
            HashValue([
                3418340634, 716403221, 1783806081, 2738932332, 3562591648, 3641772573,
            ]),
            HashValue([
                1185850181, 2263292079, 308976802, 742210783, 279276432, 3807539566,
            ]),
            HashValue([
                1261740649, 2030377769, 384490109, 1850951769, 3204619330, 3715754701,
            ]),
            HashValue([
                1761584743, 1393334531, 1700804828, 981434402, 3075606155, 1931248464,
            ]),
            HashValue([
                3046425710, 287271185, 994922478, 3394998587, 1511318234, 719354370,
            ]),
            HashValue([
                1450976054, 2587659121, 2045214447, 198719546, 2272545266, 2413057272,
            ]),
            HashValue([
                2656324544, 2792215408, 2091728060, 2712567039, 2764809943, 1049661677,
            ]),
            HashValue([
                2975799778, 54256676, 1629819490, 3272518704, 2457454171, 56719800,
            ]),
            HashValue([
                2236467621, 2372964227, 1638171515, 1245641435, 2359442090, 3033229758,
            ]),
            HashValue([
                1512946089, 2463727093, 1054199738, 1617864032, 4162479695, 1372473336,
            ]),
            HashValue([
                2264301654, 935894762, 1868836633, 996662011, 3606859399, 420813000,
            ]),
            HashValue([
                2233873129, 1322154211, 3114550515, 422451793, 4154288509, 2197388497,
            ]),
            HashValue([
                1155703777, 646105456, 2438031667, 1799074010, 1127281921, 171884989,
            ]),
            HashValue([
                858346268, 3883261916, 4133766696, 1492804007, 2545429169, 2296302321,
            ]),
        ];

        const OTS: LmotsSignature<6, 51> = LmotsSignature {
            ots_type: LMOTS_TYPE,
            nonce: NONCE,
            y: Y,
        };

        const LMS_SIG: LmsSignature<6, 51> = LmsSignature {
            q: Q,
            lmots_signature: OTS,
            sig_type: LMS_TYPE,
            lms_path: &PATH,
        };

        let success = lms.verify_lms_signature(
            sha256_driver,
            &MESSAGE,
            &LMS_IDENTIFIER,
            Q,
            &LMS_PUBLIC_KEY,
            &LMS_SIG,
        )?;
        if !success {
            raise_err!(DigestMismatch);
        }
        Ok(())
    }
}
